function ChiptunePlayer(t){this.output=t}ChiptunePlayer.prototype.fileCounter=0,ChiptunePlayer.prototype.generateFilename=function(){return"modfile"+this.fileCounter++},ChiptunePlayer.prototype.load=function(t,e,r){var a=function(){if(this.player_ptr=this.xmp.init(this.path),0==this.player_ptr){try{FS.deleteFile(this.path)}catch(t){}return r("could not initialize player")}return this.xmp.player_data[this.player_ptr]={stop:!0,pause:!1,looping:!!e},r()}.bind(this);if(t instanceof File){var p=this.generateFilename();this.path="/"+p;var i=new FileReader;i.onload=function(){FS.createDataFile("/",p,new Int8Array(i.result),!0,!0),a()},i.readAsArrayBuffer(t)}if("string"==typeof t){var s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="arraybuffer";var p=this.generateFilename();this.path="/"+p,s.onload=function(){FS.createDataFile("/",p,new Int8Array(s.response),!0,!0),a()},s.send()}},ChiptunePlayer.prototype.unload=function(){var t=this.xmp.player_data[this.player_ptr]||!1,e=this.xmp.player_data[this.player_ptr].pause,r=t&&!e;this.pause(),t&&(this.xmp.player_data[this.player_ptr].stop=!0),r||(this.xmp.free_player(this.player_ptr),delete this.xmp.player_data[this.player_ptr])},ChiptunePlayer.prototype.play=function(){this.isPaused()&&!this.isStopped()?this.resume():this.isStopped()&&(this.xmp.player_data[this.player_ptr].stop=!1,this.xmp.play.bind(this)(this.player_ptr,0,!0))},ChiptunePlayer.prototype.pause=function(){this.xmp.pause.bind(this)(this.player_ptr)},ChiptunePlayer.prototype.resume=function(){this.xmp.resume.bind(this)(this.player_ptr)},ChiptunePlayer.prototype.setLooping=function(t){this.xmp.setLooping.bind(this)(this.player_ptr,t)},ChiptunePlayer.prototype.isPaused=function(){return this.xmp.isPaused.bind(this)(this.player_ptr)},ChiptunePlayer.prototype.isStopped=function(){return this.xmp.isStopped.bind(this)(this.player_ptr)},ChiptunePlayer.prototype.xmp={init:Module.cwrap("initialize_player","number",["string"]),read:Module.cwrap("read_from_player","number",["number","bool"]),free_buffer:Module.cwrap("free_buffer","null",["number"]),free_player:Module.cwrap("free_player","null",["number"]),player_data:{},get_audio_source:function(t){var e=function(t){var e=function(t){var e=Module.getValue(t,"*"),r=Module.getValue(t+4,"i32");if(0!=r&&0!=e){var a=Module.HEAP8.subarray(e,e+r);return new Float32Array(a.buffer,e,r/4)}},r=this.xmp.read(t,this.xmp.player_data[t].looping),a=e(r);return this.xmp.free_buffer(r),a}.bind(this),r=e(t);if(void 0!==r){for(var a=0;19>a;a++){var p=e(t);if(void 0===p)break;var i=r;r=new Float32Array(i.length+p.length),r.set(i,0),r.set(p,i.length)}delete p,delete i;var s=context.createBuffer(1,r.length,44100);s.getChannelData(0).set(r);var n=context.createBufferSource();return n.buffer=s,n.connect(this.output),n}},play:function(t,e,r,a){if(r&&(this.xmp.player_data[t].next_src=this.xmp.get_audio_source.bind(this)(t)),this.xmp.player_data[t].stop===!0||void 0===this.xmp.player_data[t].next_src)return this.xmp.free_player(this.player_ptr),void delete this.xmp.player_data[t];if(!this.xmp.player_data[t].pause){var p=r?0:this.xmp.player_data[t].current_src.buffer.duration,i=r?context.currentTime:e+p;a&&(i=a),this.xmp.player_data[t].last_src=this.xmp.player_data[t].current_src,this.xmp.player_data[t].current_src=this.xmp.player_data[t].next_src,this.xmp.player_data[t].current_src.start(i),this.xmp.player_data[t].current_src.timeScheduled=i;var s=this.xmp.player_data[t].current_src.buffer.duration,n=r?1e3*s/2:1e3*s,u=setTimeout(this.xmp.play.bind(this,t,i),n);this.xmp.player_data[t].timerId=u,this.xmp.player_data[t].next_src=this.xmp.get_audio_source.bind(this)(t)}},pause:function(t){this.xmp.player_data[t]&&(this.xmp.player_data[t].last_src&&this.xmp.player_data[t].last_src.stop(0),this.xmp.player_data[t].current_src&&this.xmp.player_data[t].current_src.stop(0),this.xmp.player_data[t].pause=context.currentTime,clearTimeout(this.xmp.player_data[t].timerId))},resume:function(t){if(this.xmp.player_data[t]&&this.xmp.player_data[t].pause&&!this.xmp.player_data[t].stop){var e=this.xmp.player_data[t].pause-this.xmp.player_data[t].current_src.timeScheduled,r=0;if(e>0&&e<this.xmp.player_data[t].current_src.buffer.duration){var a=context.createBufferSource();a.buffer=this.xmp.player_data[t].current_src.buffer,a.connect(this.output),a.start(0,e),r=context.currentTime+this.xmp.player_data[t].current_src.buffer.duration-e}this.xmp.player_data[t].pause=void 0,this.xmp.play.bind(this)(t,0,!1,r)}},setLooping:function(t,e){this.xmp.player_data[t].looping=e},isPaused:function(t){try{return this.xmp.player_data[t].pause?!0:!1}catch(e){return!1}},isStopped:function(t){try{return this.xmp.player_data[t].stop?!0:!1}catch(e){return!0}}};